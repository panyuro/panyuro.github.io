---
title: RabbitMQ学习笔记
date: 2021-10-27 21:35:27
tags: rabbitMQ
categories: 中间件
---

- 中间件
  - 是一种应用于分布式系统的基础软件。
  - 常见的中间件：mysql，rabbit MQ
- 怎么选择中间件
  - 可以通信，跨平台。比方两个项目一个java，一个go之间要通信，就要遵循同一种协议
  - 高可用
    - 是否拥有持久化。比方中间件挂了，重启后是否可以把消息重新存储起来的能力
    - 支持集群。系统cpu不够用了，就得搭集群
  - 有分发能力，多个系统，往那个系统去发送消息
- 网络协议三要素：
  - 语法：用户数据的结构与形式，如：http中规定了请求和响应报文的格式
  - 语义：规定了何种信息需要对应发出何种响应，如：请求get要把参数放在url中，post把参数放在body中
  - 时序：事件的执行顺序，如：先有请求后有响应

- 为什么消息中间件不用http？
  - http的请求和响应报文比较复杂，有cookie, 状态码，响应码这些，但消息中间件：只需要接受消息，存储消息，分发消息，不需要这么复杂
  - http大部分是短链接，不利于出现故障时消息持久化

- AMQP（advanced message. Queuing protocol） 高级消息队列协议
  - 采用Erlang，底层是C，速度很快
  - 特性
    - 支持分布式事务
    - 消息持久化
    - 高性能高可靠的消息处理优势

- kafka 协议
  - 基于TCP/IP的二进制协议，消息内部由长度分割，由基本数据类型构成
  - 特性
    - 结构简单
    - 解析速度快
    - 消息持久化
    - 不支持事务

- 持久化：就是把数据 放在磁盘中，而不是单独放在内存中，让数据永久保存

- 消息的分发策略

    假设队列里有100条消息，有 A,B,C   3个队列

  - 发布订阅。三个队列都收到100条
  - 轮训分发。3个队列都是至少33条，剩下一条随机，不论你数据库性能怎么样，大家接受的都是公平的
  - 公平分发。根据服务器性能，去分发，哪个性能高，哪个处理的消息可能就多，能者多劳，会造成数据倾斜
  - 重发。发送消息中出现了异常后，消息没有得到应答，就会重发，kafka不支持
  - 消息拉取。就是RPC去拉取数据

  > Rabbitmq以上集中策略都支持，且是开源的
  >
  > kafka速度最快

- MQ消息队列中有三个角色

  - 生产者
  - 存储消息
  - 消费者
